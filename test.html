<!DOCTYPE html>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="messenger.js"></script>
        <script>
            $(function () {
                var msg = Messenger("messengertest");
                $("#send").click(function () {
                    var n = Math.random() * 10000 | 0;
                    $("#sent").text("sent " + n)
                    msg.broadcast({number: n});
                })
                msg.onReceive(function (d) {
                    $("#received").text("received " + d.number);
                });
                
                var msg2 = Messenger("requesttest", true);
                msg2.onReceive(function (d, m, respond) {
                    if (d === "knock knock")
                        respond("who's there?");
                    else if (d === "please alert")
                        alert("I was asked to alert");
                    else
                        alert("expected knock knock, got " + d + "!");
                });
                $("#request").click(function () {
                    msg2.request("knock knock", function (responses, messages) {
                        for (var i = 0; i < responses.length; i++) {
                            if (responses[i] !== "who's there?")
                                alert("response " + i + ": got " + responses[i]);
                        }
                        var choice = "none";
                        if (responses.length > 0) {
                            choice = Math.random() * responses.length | 0;
                            msg2.unicast("please alert", messages[choice].sender);
                        }
                        $("#responses").text("got " + responses.length + " replies, chose " + choice);
                    });
                });
            })
        </script>
    </head>
    <body>
        <div id="received"></div>
        <button id="send">send</button>
        <div id="sent"></div>
        
        <button id="request">request</button>
        <pre id="responses"></div>
    </body>
</html>